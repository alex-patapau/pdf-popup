<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PDF во всплывающем окне (Fancybox v5 + PDF.js)</title>

  <!-- Fancybox v5 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 40px;
      text-align: center;
      background: #fafafa;
    }
    a.button {
      display: inline-block;
      padding: 12px 24px;
      background: #0066ff;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-size: 16px;
    }
    #pdf-container {
      width: 100%;
      height: 90vh;
      overflow-y: auto;
      background: #eee;
      position: relative;
      touch-action: none;
    }
    canvas {
      display: block;
      margin: 10px auto;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
      border-radius: 4px;
      transition: transform 0.2s ease;
    }
    #pdf-controls {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-bottom: 1px solid #ccc;
      backdrop-filter: blur(5px);
    }
    #pdf-controls button {
      border: none;
      background: #0066ff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    #pdf-controls button:disabled {
      background: #aaa;
      cursor: default;
    }
    /* Прелоадер */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
      padding: 16px 24px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      display: none;
    }
  </style>
</head>
<body>

  <h1>PDF во всплывающем окне (с прелоадером, pinch, lazy)</h1>
  <p>
    <a href="javascript:void(0);" class="button" id="open-pdf">Открыть PDF</a>
  </p>

  <script>
    const pdfUrl = "https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf";

    document.getElementById('open-pdf').addEventListener('click', async () => {
      const container = document.createElement('div');
      container.id = 'pdf-container';
      const controls = document.createElement('div');
      controls.id = 'pdf-controls';
      controls.innerHTML = `
        <button id="prev-page">← Назад</button>
        <span id="page-info">Страница <b id="page-num">1</b> из <b id="page-count">?</b></span>
        <button id="next-page">Вперёд →</button>
      `;
      const loader = document.createElement('div');
      loader.id = 'loader';
      loader.textContent = 'Загрузка...';
      container.appendChild(controls);
      container.appendChild(loader);

      Fancybox.show([{ src: container, type: "html", caption: "Просмотр PDF" }]);

      const loadingTask = pdfjsLib.getDocument(pdfUrl);
      const pdf = await loadingTask.promise;
      const totalPages = pdf.numPages;
      document.getElementById('page-count').textContent = totalPages;

      const canvasCache = {};
      let currentPage = 1;
      let scale = 1.5;
      let zoom = 1;

      async function renderPage(num) {
        if (canvasCache[num]) return canvasCache[num];

        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: scale * zoom });
        const canvas = document.createElement('canvas');
        canvas.dataset.page = num;
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        loader.style.display = 'block';
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        loader.style.display = 'none';

        canvasCache[num] = canvas;
        return canvas;
      }

      async function showPage(num) {
        document.getElementById('page-num').textContent = num;
        document.getElementById('prev-page').disabled = num <= 1;
        document.getElementById('next-page').disabled = num >= totalPages;

        container.querySelectorAll('canvas').forEach(c => c.remove());
        const toRender = [num - 1, num, num + 1].filter(n => n >= 1 && n <= totalPages);
        for (const n of toRender) {
          const c = await renderPage(n);
          container.appendChild(c);
        }
      }

      // Инициализация
      showPage(currentPage);

      document.getElementById('prev-page').onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          showPage(currentPage);
        }
      };
      document.getElementById('next-page').onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        }
      };

      // Свайп
      let startX = 0;
      container.addEventListener('touchstart', e => {
        if (e.touches.length === 1) startX = e.touches[0].clientX;
      });
      container.addEventListener('touchend', e => {
        if (e.changedTouches.length === 1) {
          const endX = e.changedTouches[0].clientX;
          const delta = endX - startX;
          if (Math.abs(delta) > 60) {
            if (delta < 0 && currentPage < totalPages) currentPage++;
            if (delta > 0 && currentPage > 1) currentPage--;
            showPage(currentPage);
          }
        }
      });

      // Pinch zoom
      let startDist = 0;
      container.addEventListener('touchmove', e => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (!startDist) startDist = dist;
          const factor = dist / startDist;
          zoom = Math.min(3, Math.max(0.5, factor));
          container.querySelectorAll('canvas').forEach(c => {
            c.style.transform = `scale(${zoom})`;
          });
        }
      });
      container.addEventListener('touchend', e => {
        if (e.touches.length < 2 && startDist) {
          startDist = 0;
          showPage(currentPage);
        }
      });

      // Колесо мыши
      container.addEventListener('wheel', e => {
        if (e.deltaY > 100 && currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        } else if (e.deltaY < -100 && currentPage > 1) {
          currentPage--;
          showPage(currentPage);
        }
      });
    });
  </script>

</body>
</html>